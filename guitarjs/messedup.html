<html>
<head>
  <title>Guitar.js</title>

  <script type="text/javascript" src="../demolibs/jquery.js"></script>
  <script type="text/javascript" src="../demolibs/underscore.js"></script>
  <script type="text/javascript" src="../demolibs/backbone.js"></script>
  <script type="text/javascript" src="../mixer/models/buffered_node.js"></script>
  <script type="text/javascript" src="../mixer/models/mixer.js"></script>
  <script type="text/javascript" src="../beatinator/looper.js"></script>

  <script type="text/javascript">
    var context = new webkitAudioContext();
    var mixer = new Mixer({context: context});
    var song = new BufferedNode({location: 'fatlip-no-silence.mp3', mixer: mixer, context: context});
    var looper = new Looper({bpm: 100, beats: 64});
    looper.context = context;

    // todo: add phaser effect to tremolo

    song.fetch().done(function(){

      document.getElementById('letsrock').addEventListener('click', function(){
        var actions = {
          red: {
            '0-9.04': [1,0,1,0,1,0],
            '9.05-16.5': [1,0,1,0,1,0]
          }
        }

        var currentSlice = null;

        looper.on('change:currentBeat', function(){

          var currentTime = context.currentTime;
          var currentBeat = looper.get('currentBeat');

          for(var action in actions){
            var currentSlice = null;
            for(var timeslice in actions[action]){
              var start = parseFloat(timeslice.split('-')[0]);
              var end = parseFloat(timeslice.split('-')[1]);
              if(start <= currentTime && currentTime <= end){
                currentSlice = timeslice;
                break;
              }
            }

            if(currentSlice){
              var guitar = navigator.webkitGetGamepads()[0];
              var buttonPressed = guitar.buttons[0] == 1
              if(actions[action][currentSlice][currentBeat] && buttonPressed)
                console.log('da')
              else
                console.log('----')
            }
          }

        });

        song.play();
        looper.start();  
      })

    })

  </script>

</head>
<body>

  <button id="letsrock">Let's rock</button>

</body>
</html>